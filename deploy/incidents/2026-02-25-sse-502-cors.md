# Incident Trace: SSE 502 masked as CORS

Date: 2026-02-25

## Summary

Production dashboard showed:
- Browser error: `No 'Access-Control-Allow-Origin' header is present`
- Network error: `GET /sse/{orgId} ... 502 (Bad Gateway)`

Root cause was not CORS policy itself. The reverse proxy returned `502`, and the browser then reported CORS on the error response.

## Symptoms observed

- Client origin: `https://error-watch.tilvest.com`
- API host: `https://api.error-watch.tilvest.com`
- Failing endpoint: `/sse/:orgId`
- Caddy logs:
  - `too many transfer encodings: ["chunked" "chunked"]`
  - `reverseproxy.statusError ... status: 502`

## Root cause

SSE stream responses were going through a proxy path that could trigger invalid transfer-encoding handling (`chunked` duplicated), producing upstream transport failure (`502`) before normal application response headers.

## Fixes applied

### 1) Proxy hardening for SSE

Files:
- `deploy/Caddyfile`
- `Caddyfile`

Changes:
- Dedicated `handle @sse` block for `/sse/*`
- `header_up Accept-Encoding identity`
- `flush_interval -1`
- Upstream transport set to HTTP/1.1 with compression disabled
- Regular API traffic remains in separate `handle` block with `encode gzip zstd`

### 2) API SSE implementation hardening

Files:
- `apps/monitoring-server/src/sse/route.ts`
- `apps/monitoring-server/src/routes/v1/metrics-sse.ts`

Changes:
- Replaced helper streaming path with native `ReadableStream` responses
- Explicit SSE headers:
  - `Content-Type: text/event-stream; charset=utf-8`
  - `Cache-Control: no-cache`
  - `Connection: keep-alive`
  - `X-Accel-Buffering: no`
- Explicit Redis cleanup on abort/cancel
- Keepalive `ping` event every 15s

## Validation performed

- API health check: `200` on `/health/live`
- Public SSE without cookie: `401` (expected for auth-protected stream)
- Caddy config in container confirmed with SSE dedicated `handle`
- Post-deploy Caddy logs: no new `too many transfer encodings` entries in recent window

## Commits

- `8979654` `fix(caddy): isolate SSE proxy path to prevent double chunked 502`
- `bd6d4c6` `fix(api): avoid streamSSE transfer-encoding issues behind caddy`
- `3e38a77` `fix(api): use native ReadableStream for org SSE endpoint`

## Remaining operational note

Server repo contains unrelated local modification:
- `apps/dashboard/src/proxy.ts`

It was preserved intentionally and not reset during production pull/restart.
